<!DOCTYPE html>
<html class="" lang="de">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>{{HOSTNAME}} - Systemprotokoll</title>

<script>
	var x = null,
		lt, to, tp, pc = '';
	var sn = 0;
	var id = 0;

	function l(p) {
		var c, o, t;
		clearTimeout(lt);
		o = '';
		t = document.getElementById('t1');
		if (p == 1) {
			c = document.getElementById('c1');
			o = '&c1=' + encodeURIComponent(c.value);
			c.value = '';
			t.scrollTop = sn;
		}
		if (t.scrollTop >= sn) {
			if (x != null) {
				x.abort();
			}
			x = new XMLHttpRequest();
			x.onreadystatechange = function() {
				if (x.readyState == 4 && x.status == 200) {
					var z, d;
					d = x.responseText.split(/}1/);
					id = d.shift();
					if (d.shift() == 0) {
						t.value = '';
					}
					z = d.shift();
					if (z.length > 0) {
						t.value += z;
					}
					t.scrollTop = 99999;
					sn = t.scrollTop;
				}
			};
			x.open('GET', 'cs?c2=' + id + o, true);
			x.send();
		}
		lt = setTimeout(l, 2345);
		return false;
	}
	//window.onload = l;
	

function pad(value) {
    if (value <= 9) {
        return "0" + value;
    }
    return value;
}

function addOneLine(value) {
    let ts = value.ts;
    let msg = value.msg;
    let d = new Date(ts * 1000);
    document.getElementById('t1').innerHTML +=
		d + ": " + msg + '\\r';

		/*d.getFullYear()
		+ "-" + pad(d.getMonth() + 1)
		+ "-" + pad(d.getDate())
		+ " " + pad(d.getHours())
		+ ":" + pad(d.getMinutes())
		+ ":" + pad(d.getSeconds())*/
}

var req = null;

function read_state() {
    if (req != null) {
        req.abort();
    }
    req = new XMLHttpRequest();
    req.onreadystatechange = function() {
        if (req.readyState == 4 && req.status == 200) {
            var obj = JSON.parse(req.responseText);
            obj.log.forEach(addOneLine);
        }
    };
    req.open('GET', '/logd?t=0', true);
    req.send();
    setTimeout(read_state, 2345);
}

simreq = {"log":[{"ts":7203, "msg":"WiFi connected (IP: 192.168.0.157)"}
,{"ts":7203, "msg":"OTA ready (192.168.0.157)"}
,{"ts":1570571455, "msg":"Free RAM: 44896, largest: 44888"}
,{"ts":1570571476, "msg":"send_file(): /log.html"}
,{"ts":1570571513, "msg":"send_file(): /log.html"}
,{"ts":1570571515, "msg":"Free RAM: 44128, largest: 43848"}
]};

function sim() {
	var obj = simreq;
	obj.log.forEach(addOneLine);
}

window.onload = read_state();
//setTimeout(sim, 3000);

</script>

<style>
{{CSS}}
</style>
</head>

<body>
<body>
	<div style="text-align:left;display:inline-block;min-width:340px;">
		<div style="text-align:center;">
			<noscript>Bitte aktivieren Sie JavaScript<br/></noscript>
			<h3>OnsenPID</h3>
			<h2>{{HOSTNAME}}</h2>
		</div>
		<br /><textarea readonly id='t1' name='t1' cols='340' wrap='off'></textarea><br /><br />
		<div></div>
		<p><form action='/' method='get'><button>Zur√ºck</button></form>	</p><br />
		<div style='text-align:right;font-size:11px;'><hr /><a href='https://bit.ly/tasmota' target='_blank' style='color:#aaa;'>OnsenPID by Franz Hoffmann</a></div>
	</div>
</body>

</html>
